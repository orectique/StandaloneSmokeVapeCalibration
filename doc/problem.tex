\documentclass[]{article}

\usepackage[margin=3.4cm]{geometry}
\usepackage{amsmath}
\usepackage{amsfonts}
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.2cm}
\renewcommand{\baselinestretch}{1}
\usepackage[obeyspaces]{url}
\usepackage{listings}

\usepackage[colorinlistoftodos,prependcaption,textsize=small]{todonotes}

% Default fixed font does not support bold face
\DeclareFixedFont{\ttb}{T1}{txtt}{bx}{n}{8} % for bold
\DeclareFixedFont{\ttm}{T1}{txtt}{m}{n}{8}  % for normal

% Tabular stretch
\def\arraystretch{1.5}

\usepackage{xltabular}
\usepackage{xcolor}
\newcommand\textr[1]{\textcolor{red}{#1}}

% Custom colors
\usepackage{color}
\definecolor{deepblue}{rgb}{0,0,0.5}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.5,0}
\usepackage{listings}
% Python style for highlighting
\newcommand\pythonstyle{\lstset{
		language=Python,
		basicstyle=\ttm,
		morekeywords={self},              % Add keywords here
		keywordstyle=\ttb\color{deepblue},
		emph={MyClass,__init__},          % Custom highlighting
		emphstyle=\ttb\color{deepred},    % Custom highlighting style
		stringstyle=\color{deepgreen},
		frame=tb,                         % Any extra options here
		showstringspaces=false
}}


% Python environment
\lstnewenvironment{python}[1][]
{
	\pythonstyle
	\lstset{#1}
}
{}

% Python for external files
\newcommand\pythonexternal[2][]{{
		\pythonstyle
		\lstinputlisting[#1]{#2}}}

% Python for inline
\newcommand\pythoninline[1]{{\pythonstyle\lstinline!#1!}}

% math mode text path-style formating
\newcommand\mt[1]{\ensuremath{\text{\path{#1}}}}

%opening
\title{Standalone Smoking Vaping Calibration}
\author{Tim Wilson}

\begin{document}
	
	\maketitle
	
	\section{Underlying Simulation Model}
	
	The underlying model for smoking and vaping is a compartmental flow model. The model tracks $220$ cohort, where a \emph{cohort} is a combination of age and sex. The model is initialised with \path{initialPrevlance.csv} runs from year 2021 to 2039 inclusive. Within each year, the model increments ages and then evaluates the flows in the model.
	
	\subsection{Increment Ages}
	The age of each cohort is incremented at the start of the year. In other words, the prevalence among a cohort of age $n$ at the start of year $t$ is equal to the prevalence of the cohort with age $n-1$ at the end of year $t-1$.
	
	Cohorts of age $\geq 110$ are removed, and cohorts of age $0$ are inserted each year. The newly inserted cohorts are initialised with the never smoker state ($n$) set to $1$.
	
	\subsection{Evaluate Flows}
	
	Flows are evaluated using a rough approximation, because the rates tend to be low. The quality of the optimisation depends on the number of time steps used.
	
	The flow rate are determined by reading the base rate from \path{flow_rate.csv} and applying an annual percentage change (APC), relative to the base year, from \path{flow_apc.csv}. The flow from state $x$ to state $y$ is denoted \path{x_y} in the file. Let $S$ be the states (compartments) of the model, then for $x,y \in S$, the flow rate in year $t$ is
	\begin{align*}
		r_{x, y, t} := b_{x,y} (1 + a_{x,y})^{t - 2021}
	\end{align*}
	where $b_{x, y}$ is base rate and $a_{x,y}$ is the APC.
	
	The flows are applied over a number of time steps, $s$, which defaults to $4$. Within each time step, the total flow out of a state, $x \in S$, is
	\begin{align*}
		f_{x, t} := \sum_{s \in S} r_{x, y, t}
	\end{align*}
	and the mass that flows from state $x$ to $y \in S$ is
	\begin{align*}
		p_{x, y, t} :=\left(1 - e^\frac{-f_{x, t}}{s}\right) \frac{r_{x, y, t}}{f_{x, t}}.
	\end{align*}
	Essentially, the flow \emph{rate} out of $x$ is being converted to a proportion, then split proportionally by the contribution each individual flow makes to the rate.
	
	The mass, $m_{x}$ of a state is then updated as follows
	\begin{align*}
		\text{out}_x :=& m_x\sum_{s \in S} p_{x,s} \\
		\text{in}_x :=& \sum_{s \in S}m_s p_{s,x} \\
		m_x \xrightarrow{\text{update}}& m_x - \text{out}_x + \text{in}_x
	\end{align*}
	
	This process is repeated $s$ times per year.
	
	\section{Calibration}
	
	The model is calibrated by modifying a limited set of base flow rates and APCs. The male and female cohorts can be calibrated separately, so sex is ignored for the following.
	
	\subsection{Objective Function}
	The target of the model is the sum of the square of the difference between the prevalence values calculated for each year, and the values in \path{prevalenceTargets.csv}. The target file sets aggregate smoking and vaping targets, rather than targets for particular states in the compartmental model. The aggregates map to the states as follows, and must be computed from model output to compare to the targets.
	\begin{align*}
		\text{smoking} &= \left(\text{\path{s}} + \text{\path{sv}}\right) / (1 - \text{\path{dead}}) \\
		\text{vaping} &= \left(\text{\path{v}} + \text{\path{vrs}} + \text{\path{sv}}\right) / (1 - \text{\path{dead}})
	\end{align*}
	Contributions to model score is weighted by \path{scoreWeight.csv}, where the agecategory part of the index is expanded to ages $n$ to $m-1$, where $n$ is the current category and $m$ is the next category. The last category has $m = 110$.
	
	In summary, the objective function scores a point in parameters space as follows.
	\begin{align*}
		\text{score} := \sum_{a \in [0\ldots110]} \sum_{t \in [2021\ldots2040]} \sum_{B \in \{\text{smoking}, \text{vaping}\}}\left(w_{a, t, B} \left(\text{target $B$}_{a, t} - \text{model $B$}_{a, t}\right)\right)^2
	\end{align*}
	The weights are squared for technical reasons to do with how the full framework processes cohort comparisons.
	
	\subsection{Parameter Space}
	The parameter space is a limited set of flows, with pins at particular ages. The parameter space only directly contains the flows \path{n_s}, \path{s_rs}, \path{n_v}, \path{v_rv}, \path{s_vrs} and \path{v_s}. All other flows are either static (as in the case for flows to \path{dead}), or derived from other flows.
	
	The parameter has pins at ages 0, 14, 15, 16, 18, 21, 24, 28, 33, 40, 50, 60, 70, 90 and 109. Values for other ages are linearly interpolated between these pins. There are pins at ages. The 14, 15, 16 pins allow for sudden sharp uptake rates at age 15, to capture pre-15 prevalence, and the pins are more frequent for younger ages as the calibration target shows sharper changes in behaviour at these ages.
	
	In total, the model has 180 ($6 \times 15 \times 2$) parameters, corresponding to combinations of flows, age pins, and split by base rate and APC. The range of each parameter is defined by the \path{flow_apc_upper}, \path{flow_apc_lower}, \path{flow_rate_upper} and \path{flow_rate_lower} files. These latter two files are indexed by agecategory, which can be expanded in ages as explained in the section above. In practise the model has fewer than 180 parameters since many of them have and upper and lower bound of zero.
	
	
\end{document}